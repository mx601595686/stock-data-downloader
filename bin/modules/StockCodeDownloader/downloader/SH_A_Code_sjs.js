"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const dsv = require("d3-dsv");
const iconv = require("iconv-lite");
const expect = require("expect.js");
const HttpDownloader = require("../../../tools/HttpDownloader");
const StockMarket_1 = require("../../StockMarketDownloader/StockMarket");
const Retry_1 = require("../../../tools/Retry");
/**
 * 上交所，股票列表数据
 *
 * 上交所只提供上海交易所的A股股票列表。返回`tsv`格式的数据，GBK编码
 *
 * 相关页面：http://www.sse.com.cn/assortment/stock/list/share/
 * 下载地址：http://query.sse.com.cn/security/stock/downloadStockListFile.do?csrcCode=&stockCode=&areaName=&stockType=1
 *
 * 注意：下载时服务器会检测"http request"头中"Referer"是否等于"http://www.sse.com.cn/assortment/stock/list/share/"
 */
//下载地址
const address = 'http://query.sse.com.cn/security/stock/downloadStockListFile.do?csrcCode=&stockCode=&areaName=&stockType=1';
const referer = "http://www.sse.com.cn/assortment/stock/list/share/";
//下载数据
async function download() {
    const file = await HttpDownloader.Get(address, { Referer: referer });
    const data = iconv.decode(file, 'gbk'); //转码
    const result = dsv.tsvParse(data);
    return result.map(item => ({
        code: item['A股代码'].trim(),
        name: item['A股简称'].trim(),
        market: StockMarket_1.StockMarket.sh.id,
        isIndex: false
    }));
}
//检测下载的数据是否正确
function test(data) {
    expect(data.length).to.greaterThan(0);
    data.forEach(item => {
        expect(/^6\d{5}$/.test(item.code)).to.be.ok(); //股票代码
        expect(item.name.length).to.greaterThan(0); //确保公司名称不为空
    });
    return data;
}
/**
 * 上海A股代码下载器
 */
exports.SH_A_Code_sjs = Retry_1.Retry3(async () => test(await download()));

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvU3RvY2tDb2RlRG93bmxvYWRlci9kb3dubG9hZGVyL1NIX0FfQ29kZV9zanMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4QkFBOEI7QUFDOUIsb0NBQW9DO0FBQ3BDLG9DQUFxQztBQUVyQyxnRUFBZ0U7QUFDaEUseUVBQXNFO0FBRXRFLGdEQUE4QztBQUU5Qzs7Ozs7Ozs7O0dBU0c7QUFFSCxNQUFNO0FBQ04sTUFBTSxPQUFPLEdBQUcsNEdBQTRHLENBQUM7QUFDN0gsTUFBTSxPQUFPLEdBQUcsb0RBQW9ELENBQUM7QUFFckUsTUFBTTtBQUNOLEtBQUs7SUFDRCxNQUFNLElBQUksR0FBRyxNQUFNLGNBQWMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDckUsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBSyxJQUFJO0lBQ2hELE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFbEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksRUFBRyxJQUFJLENBQUMsTUFBTSxDQUFZLENBQUMsSUFBSSxFQUFFO1FBQ3JDLElBQUksRUFBRyxJQUFJLENBQUMsTUFBTSxDQUFZLENBQUMsSUFBSSxFQUFFO1FBQ3JDLE1BQU0sRUFBRSx5QkFBVyxDQUFDLEVBQUUsQ0FBQyxFQUFFO1FBQ3pCLE9BQU8sRUFBRSxLQUFLO0tBQ2pCLENBQUMsQ0FBQyxDQUFDO0FBQ1IsQ0FBQztBQUVELGFBQWE7QUFDYixjQUFjLElBQStCO0lBQ3pDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUV0QyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ2hCLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBRSxNQUFNO1FBQ3RELE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBSyxXQUFXO0lBQy9ELENBQUMsQ0FBQyxDQUFDO0lBRUgsTUFBTSxDQUFDLElBQUksQ0FBQztBQUNoQixDQUFDO0FBRUQ7O0dBRUc7QUFDVSxRQUFBLGFBQWEsR0FBRyxjQUFNLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoibW9kdWxlcy9TdG9ja0NvZGVEb3dubG9hZGVyL2Rvd25sb2FkZXIvU0hfQV9Db2RlX3Nqcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGRzdiBmcm9tICdkMy1kc3YnO1xyXG5pbXBvcnQgKiBhcyBpY29udiBmcm9tICdpY29udi1saXRlJztcclxuaW1wb3J0IGV4cGVjdCA9IHJlcXVpcmUoJ2V4cGVjdC5qcycpO1xyXG5cclxuaW1wb3J0ICogYXMgSHR0cERvd25sb2FkZXIgZnJvbSAnLi4vLi4vLi4vdG9vbHMvSHR0cERvd25sb2FkZXInO1xyXG5pbXBvcnQgeyBTdG9ja01hcmtldCB9IGZyb20gJy4uLy4uL1N0b2NrTWFya2V0RG93bmxvYWRlci9TdG9ja01hcmtldCc7XHJcbmltcG9ydCB7IFN0b2NrQ29kZURvd25sb2FkZWREYXRhIH0gZnJvbSAnLi4vU3RvY2tDb2RlRG93bmxvYWRlZERhdGEnO1xyXG5pbXBvcnQgeyBSZXRyeTMgfSBmcm9tICcuLi8uLi8uLi90b29scy9SZXRyeSc7XHJcblxyXG4vKipcclxuICog5LiK5Lqk5omA77yM6IKh56Wo5YiX6KGo5pWw5o2uXHJcbiAqIFxyXG4gKiDkuIrkuqTmiYDlj6rmj5DkvpvkuIrmtbfkuqTmmJPmiYDnmoRB6IKh6IKh56Wo5YiX6KGo44CC6L+U5ZueYHRzdmDmoLzlvI/nmoTmlbDmja7vvIxHQkvnvJbnoIFcclxuICogXHJcbiAqIOebuOWFs+mhtemdou+8mmh0dHA6Ly93d3cuc3NlLmNvbS5jbi9hc3NvcnRtZW50L3N0b2NrL2xpc3Qvc2hhcmUvXHJcbiAqIOS4i+i9veWcsOWdgO+8mmh0dHA6Ly9xdWVyeS5zc2UuY29tLmNuL3NlY3VyaXR5L3N0b2NrL2Rvd25sb2FkU3RvY2tMaXN0RmlsZS5kbz9jc3JjQ29kZT0mc3RvY2tDb2RlPSZhcmVhTmFtZT0mc3RvY2tUeXBlPTFcclxuICpcclxuICog5rOo5oSP77ya5LiL6L295pe25pyN5Yqh5Zmo5Lya5qOA5rWLXCJodHRwIHJlcXVlc3RcIuWktOS4rVwiUmVmZXJlclwi5piv5ZCm562J5LqOXCJodHRwOi8vd3d3LnNzZS5jb20uY24vYXNzb3J0bWVudC9zdG9jay9saXN0L3NoYXJlL1wiXHJcbiAqL1xyXG5cclxuLy/kuIvovb3lnLDlnYBcclxuY29uc3QgYWRkcmVzcyA9ICdodHRwOi8vcXVlcnkuc3NlLmNvbS5jbi9zZWN1cml0eS9zdG9jay9kb3dubG9hZFN0b2NrTGlzdEZpbGUuZG8/Y3NyY0NvZGU9JnN0b2NrQ29kZT0mYXJlYU5hbWU9JnN0b2NrVHlwZT0xJztcclxuY29uc3QgcmVmZXJlciA9IFwiaHR0cDovL3d3dy5zc2UuY29tLmNuL2Fzc29ydG1lbnQvc3RvY2svbGlzdC9zaGFyZS9cIjtcclxuXHJcbi8v5LiL6L295pWw5o2uXHJcbmFzeW5jIGZ1bmN0aW9uIGRvd25sb2FkKCk6IFByb21pc2U8U3RvY2tDb2RlRG93bmxvYWRlZERhdGFbXT4ge1xyXG4gICAgY29uc3QgZmlsZSA9IGF3YWl0IEh0dHBEb3dubG9hZGVyLkdldChhZGRyZXNzLCB7IFJlZmVyZXI6IHJlZmVyZXIgfSk7XHJcbiAgICBjb25zdCBkYXRhID0gaWNvbnYuZGVjb2RlKGZpbGUsICdnYmsnKTsgICAgIC8v6L2s56CBXHJcbiAgICBjb25zdCByZXN1bHQgPSBkc3YudHN2UGFyc2UoZGF0YSk7XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdC5tYXAoaXRlbSA9PiAoe1xyXG4gICAgICAgIGNvZGU6IChpdGVtWydB6IKh5Luj56CBJ10gYXMgc3RyaW5nKS50cmltKCksXHJcbiAgICAgICAgbmFtZTogKGl0ZW1bJ0HogqHnroDnp7AnXSBhcyBzdHJpbmcpLnRyaW0oKSxcclxuICAgICAgICBtYXJrZXQ6IFN0b2NrTWFya2V0LnNoLmlkLFxyXG4gICAgICAgIGlzSW5kZXg6IGZhbHNlXHJcbiAgICB9KSk7XHJcbn1cclxuXHJcbi8v5qOA5rWL5LiL6L2955qE5pWw5o2u5piv5ZCm5q2j56GuXHJcbmZ1bmN0aW9uIHRlc3QoZGF0YTogU3RvY2tDb2RlRG93bmxvYWRlZERhdGFbXSkge1xyXG4gICAgZXhwZWN0KGRhdGEubGVuZ3RoKS50by5ncmVhdGVyVGhhbigwKTtcclxuICAgIFxyXG4gICAgZGF0YS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgIGV4cGVjdCgvXjZcXGR7NX0kLy50ZXN0KGl0ZW0uY29kZSkpLnRvLmJlLm9rKCk7ICAvL+iCoeelqOS7o+eggVxyXG4gICAgICAgIGV4cGVjdChpdGVtLm5hbWUubGVuZ3RoKS50by5ncmVhdGVyVGhhbigwKTsgICAgIC8v56Gu5L+d5YWs5Y+45ZCN56ew5LiN5Li656m6XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gZGF0YTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOS4iua1t0HogqHku6PnoIHkuIvovb3lmahcclxuICovXHJcbmV4cG9ydCBjb25zdCBTSF9BX0NvZGVfc2pzID0gUmV0cnkzKGFzeW5jICgpID0+IHRlc3QoYXdhaXQgZG93bmxvYWQoKSkpO1xyXG4iXX0=
