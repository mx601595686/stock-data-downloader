"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const mysql = require("mysql");
const service_starter_1 = require("service-starter");
/**
 * 连接mysql并创建数据库
 */
class MysqlConnection extends service_starter_1.BaseServiceModule {
    /**
     * 对mysql的query方法进行了一下包装，使之支持Promise
     */
    asyncQuery(sql, values) {
        return new Promise((resolve, reject) => {
            this.connection.query(sql, values, function (err, result, filed) {
                err ? reject(err) : resolve(result);
            });
        });
    }
    onStart() {
        return new Promise((resolve, reject) => {
            this.connection = mysql.createConnection({
                host: process.env.MYSQL_HOST_ADDR || 'localhost',
                port: process.env.MYSQL_HOST_PORT || 3306,
                user: process.env.MYSQL_USERNAME || 'root',
                password: process.env.MYSQL_PASSWORD || 'root' //登陆密码
            });
            this.connection.connect(err => {
                if (err) {
                    reject(err);
                }
                else {
                    this.connection.query("CREATE SCHEMA IF NOT EXISTS `stock`;", err => err ? reject(err) : resolve());
                }
            });
            this.connection.on("end", (err) => {
                if (err)
                    this.emit('error', err);
                if (this.servicesManager.status !== service_starter_1.RunningStatus.stopping && this.servicesManager.status !== service_starter_1.RunningStatus.stopped)
                    this.servicesManager.stop();
            });
            this.connection.on("error", err => this.emit("error", err));
        });
    }
    onStop() {
        return new Promise((resolve, reject) => {
            this.connection.end(err => err ? reject(err) : resolve());
        });
    }
    async onHealthCheck() {
        try {
            await this.asyncQuery("SELECT 'OK';");
        }
        catch (error) {
            throw new Error('数据库连接状态异常：' + error);
        }
    }
}
exports.MysqlConnection = MysqlConnection;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZHVsZXMvTXlzcWxDb25uZWN0aW9uL015c3FsQ29ubmVjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUErQjtBQUMvQixxREFBbUU7QUFFbkU7O0dBRUc7QUFDSCxxQkFBNkIsU0FBUSxtQ0FBaUI7SUFJbEQ7O09BRUc7SUFDSCxVQUFVLENBQUMsR0FBVyxFQUFFLE1BQWM7UUFDbEMsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3hDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxNQUFNLEVBQUUsVUFBVSxHQUFHLEVBQUUsTUFBTSxFQUFFLEtBQUs7Z0JBQzNELEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxPQUFPO1FBQ0gsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ25DLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDO2dCQUNyQyxJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksV0FBVztnQkFDaEQsSUFBSSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxJQUFJLElBQUk7Z0JBQ3pDLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxNQUFNO2dCQUMxQyxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksTUFBTSxDQUFNLE1BQU07YUFDN0QsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQzFCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQ04sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNoQixDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLHNDQUFzQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7Z0JBQ3hHLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUM5QixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUM7b0JBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBRWpDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxLQUFLLCtCQUFhLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxLQUFLLCtCQUFhLENBQUMsT0FBTyxDQUFDO29CQUNoSCxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3BDLENBQUMsQ0FBQyxDQUFDO1lBRUgsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNoRSxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxNQUFNO1FBQ0YsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFPLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3pDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDOUQsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsS0FBSyxDQUFDLGFBQWE7UUFDZixJQUFJLENBQUM7WUFDRCxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDMUMsQ0FBQztRQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDYixNQUFNLElBQUksS0FBSyxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsQ0FBQztRQUMxQyxDQUFDO0lBQ0wsQ0FBQztDQUNKO0FBeERELDBDQXdEQyIsImZpbGUiOiJtb2R1bGVzL015c3FsQ29ubmVjdGlvbi9NeXNxbENvbm5lY3Rpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBteXNxbCBmcm9tICdteXNxbCc7XHJcbmltcG9ydCB7IEJhc2VTZXJ2aWNlTW9kdWxlLCBSdW5uaW5nU3RhdHVzIH0gZnJvbSBcInNlcnZpY2Utc3RhcnRlclwiO1xyXG5cclxuLyoqXHJcbiAqIOi/nuaOpW15c3Fs5bm25Yib5bu65pWw5o2u5bqTXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgTXlzcWxDb25uZWN0aW9uIGV4dGVuZHMgQmFzZVNlcnZpY2VNb2R1bGUge1xyXG5cclxuICAgIGNvbm5lY3Rpb246IG15c3FsLkNvbm5lY3Rpb247XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlr7lteXNxbOeahHF1ZXJ55pa55rOV6L+b6KGM5LqG5LiA5LiL5YyF6KOF77yM5L2/5LmL5pSv5oyBUHJvbWlzZVxyXG4gICAgICovXHJcbiAgICBhc3luY1F1ZXJ5KHNxbDogc3RyaW5nLCB2YWx1ZXM/OiBhbnlbXSkge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLnF1ZXJ5KHNxbCwgdmFsdWVzLCBmdW5jdGlvbiAoZXJyLCByZXN1bHQsIGZpbGVkKSB7XHJcbiAgICAgICAgICAgICAgICBlcnIgPyByZWplY3QoZXJyKSA6IHJlc29sdmUocmVzdWx0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgb25TdGFydCgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24gPSBteXNxbC5jcmVhdGVDb25uZWN0aW9uKHtcclxuICAgICAgICAgICAgICAgIGhvc3Q6IHByb2Nlc3MuZW52Lk1ZU1FMX0hPU1RfQUREUiB8fCAnbG9jYWxob3N0JywgICAvL+S4u+acuuWcsOWdgFxyXG4gICAgICAgICAgICAgICAgcG9ydDogcHJvY2Vzcy5lbnYuTVlTUUxfSE9TVF9QT1JUIHx8IDMzMDYsICAgICAgICAgIC8v6L+e5o6l56uv5Y+jXHJcbiAgICAgICAgICAgICAgICB1c2VyOiBwcm9jZXNzLmVudi5NWVNRTF9VU0VSTkFNRSB8fCAncm9vdCcsICAgICAgICAgLy/nlKjmiLflkI1cclxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwcm9jZXNzLmVudi5NWVNRTF9QQVNTV09SRCB8fCAncm9vdCcgICAgICAvL+eZu+mZhuWvhueggVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5jb25uZWN0KGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgeyAgICAvL+WIm+W7uuezu+e7n+aJgOmcgOeahOaVsOaNruW6k1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5xdWVyeShcIkNSRUFURSBTQ0hFTUEgSUYgTk9UIEVYSVNUUyBgc3RvY2tgO1wiLCBlcnIgPT4gZXJyID8gcmVqZWN0KGVycikgOiByZXNvbHZlKCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5vbihcImVuZFwiLCAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB0aGlzLmVtaXQoJ2Vycm9yJywgZXJyKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zZXJ2aWNlc01hbmFnZXIuc3RhdHVzICE9PSBSdW5uaW5nU3RhdHVzLnN0b3BwaW5nICYmIHRoaXMuc2VydmljZXNNYW5hZ2VyLnN0YXR1cyAhPT0gUnVubmluZ1N0YXR1cy5zdG9wcGVkKVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VydmljZXNNYW5hZ2VyLnN0b3AoKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24ub24oXCJlcnJvclwiLCBlcnIgPT4gdGhpcy5lbWl0KFwiZXJyb3JcIiwgZXJyKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgb25TdG9wKCkge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5lbmQoZXJyID0+IGVyciA/IHJlamVjdChlcnIpIDogcmVzb2x2ZSgpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBhc3luYyBvbkhlYWx0aENoZWNrKCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYXN5bmNRdWVyeShcIlNFTEVDVCAnT0snO1wiKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+aVsOaNruW6k+i/nuaOpeeKtuaAgeW8guW4uO+8micgKyBlcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il19
