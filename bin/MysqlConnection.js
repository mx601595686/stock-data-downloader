"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const mysql = require("mysql");
const service_starter_1 = require("service-starter");
class MysqlConnection extends service_starter_1.BaseServiceModule {
    /**
     * 对mysql的query方法进行了一下包装
     */
    asyncQuery(sql) {
        return new Promise((resolve, reject) => {
            this.connection.query(sql, function (err, result, filed) {
                err ? reject(err) : resolve(result);
            });
        });
    }
    onStart() {
        return new Promise((resolve, reject) => {
            this.connection = mysql.createConnection({
                host: process.env.MYSQL_HOST_PORT || 'localhost',
                port: process.env.MYSQL_HOST_ADDR || 3306,
                user: process.env.MYSQL_USERNAME || 'root',
                password: process.env.MYSQL_PASSWORD || 'root' //登陆密码
            });
            this.connection.connect(err => err ? reject(err) : resolve());
            this.connection.on("end", err => err && this.emit("error", err));
            this.connection.on("error", err => this.emit("error", err));
        });
    }
    onStop() {
        return new Promise((resolve, reject) => {
            this.connection.end(err => err ? reject(err) : resolve());
        });
    }
    async onHealthCheck() {
        try {
            await this.asyncQuery("SELECT 'OK';");
        }
        catch (error) {
            throw new Error('数据库连接状态异常：' + error);
        }
    }
}
exports.MysqlConnection = MysqlConnection;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk15c3FsQ29ubmVjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUErQjtBQUMvQixxREFBb0Q7QUFFcEQscUJBQTZCLFNBQVEsbUNBQWlCO0lBSWxEOztPQUVHO0lBQ0gsVUFBVSxDQUFDLEdBQVc7UUFDbEIsTUFBTSxDQUFDLElBQUksT0FBTyxDQUFNLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3hDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxVQUFVLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSztnQkFDbkQsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN4QyxDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELE9BQU87UUFDSCxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDbkMsSUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3JDLElBQUksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxXQUFXO2dCQUNoRCxJQUFJLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksSUFBSTtnQkFDekMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLE1BQU07Z0JBQzFDLFFBQVEsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxNQUFNLENBQU0sTUFBTTthQUM3RCxDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBRTlELElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2pFLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDaEUsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsTUFBTTtRQUNGLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUN6QyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzlELENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELEtBQUssQ0FBQyxhQUFhO1FBQ2YsSUFBSSxDQUFDO1lBQ0QsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzFDLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBQ2IsTUFBTSxJQUFJLEtBQUssQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFDMUMsQ0FBQztJQUNMLENBQUM7Q0FDSjtBQTVDRCwwQ0E0Q0MiLCJmaWxlIjoiTXlzcWxDb25uZWN0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgbXlzcWwgZnJvbSAnbXlzcWwnO1xyXG5pbXBvcnQgeyBCYXNlU2VydmljZU1vZHVsZSB9IGZyb20gXCJzZXJ2aWNlLXN0YXJ0ZXJcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBNeXNxbENvbm5lY3Rpb24gZXh0ZW5kcyBCYXNlU2VydmljZU1vZHVsZSB7XHJcblxyXG4gICAgY29ubmVjdGlvbjogbXlzcWwuQ29ubmVjdGlvbjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIOWvuW15c3Fs55qEcXVlcnnmlrnms5Xov5vooYzkuobkuIDkuIvljIXoo4VcclxuICAgICAqL1xyXG4gICAgYXN5bmNRdWVyeShzcWw6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLnF1ZXJ5KHNxbCwgZnVuY3Rpb24gKGVyciwgcmVzdWx0LCBmaWxlZCkge1xyXG4gICAgICAgICAgICAgICAgZXJyID8gcmVqZWN0KGVycikgOiByZXNvbHZlKHJlc3VsdCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG9uU3RhcnQoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uID0gbXlzcWwuY3JlYXRlQ29ubmVjdGlvbih7XHJcbiAgICAgICAgICAgICAgICBob3N0OiBwcm9jZXNzLmVudi5NWVNRTF9IT1NUX1BPUlQgfHwgJ2xvY2FsaG9zdCcsICAgLy/kuLvmnLrlnLDlnYBcclxuICAgICAgICAgICAgICAgIHBvcnQ6IHByb2Nlc3MuZW52Lk1ZU1FMX0hPU1RfQUREUiB8fCAzMzA2LCAgICAgICAgICAvL+i/nuaOpeerr+WPo1xyXG4gICAgICAgICAgICAgICAgdXNlcjogcHJvY2Vzcy5lbnYuTVlTUUxfVVNFUk5BTUUgfHwgJ3Jvb3QnLCAgICAgICAgIC8v55So5oi35ZCNXHJcbiAgICAgICAgICAgICAgICBwYXNzd29yZDogcHJvY2Vzcy5lbnYuTVlTUUxfUEFTU1dPUkQgfHwgJ3Jvb3QnICAgICAgLy/nmbvpmYblr4bnoIFcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb24uY29ubmVjdChlcnIgPT4gZXJyID8gcmVqZWN0KGVycikgOiByZXNvbHZlKCkpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLm9uKFwiZW5kXCIsIGVyciA9PiBlcnIgJiYgdGhpcy5lbWl0KFwiZXJyb3JcIiwgZXJyKSk7XHJcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbi5vbihcImVycm9yXCIsIGVyciA9PiB0aGlzLmVtaXQoXCJlcnJvclwiLCBlcnIpKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBvblN0b3AoKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jb25uZWN0aW9uLmVuZChlcnIgPT4gZXJyID8gcmVqZWN0KGVycikgOiByZXNvbHZlKCkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIGFzeW5jIG9uSGVhbHRoQ2hlY2soKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgYXdhaXQgdGhpcy5hc3luY1F1ZXJ5KFwiU0VMRUNUICdPSyc7XCIpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcign5pWw5o2u5bqT6L+e5o6l54q25oCB5byC5bi477yaJyArIGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=
